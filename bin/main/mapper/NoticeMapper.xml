<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.mapper.NoticeMapper">

    <select id="getNoticeList" parameterType="NoticeSearchRequest" resultType="NoticeResponse">
        SELECT 
            n.id,
            n.title,
            n.content,
            n.status,
            n.priority,
            n.notice_start_at as noticeStartAt,
            n.notice_end_at as noticeEndAt,
            n.view_count as viewCount,
            n.created_at as createdAt,
            n.updated_at as updatedAt,
            n.created_user_id as createdUserId,
            ac.name as createdUserName,
            au.name as updatedUserName
        FROM notice n
        LEFT JOIN admin ac ON ac.id = n.created_user_id
        LEFT JOIN admin au ON au.id = n.updated_user_id
        <where>
            <if test="title != null and title != ''">
                AND n.title LIKE CONCAT('%', #{title}, '%')
            </if>
            <if test="content != null and content != ''">
                AND n.content LIKE CONCAT('%', #{content}, '%')
            </if>
            <if test="status != null and status != ''">
                AND n.status = #{status}
            </if>
            <if test="priority != null and priority != ''">
                AND n.priority = #{priority}
            </if>
            <!-- 사용자용 검색일 때만 현재 날짜가 공지 기간 내에 있는 공지사항만 조회 -->
            <if test="isUserSearch == true">
                AND (n.notice_start_at IS NULL OR n.notice_start_at &lt;= NOW())
                AND (n.notice_end_at IS NULL OR n.notice_end_at &gt;= NOW())
            </if>
        </where>
        <choose>
            <when test="sortOrder == 'latest'">
                ORDER BY n.created_at DESC
            </when>
            <when test="sortOrder == 'oldest'">
                ORDER BY n.created_at ASC
            </when>
            <when test="sortOrder == 'views'">
                ORDER BY n.view_count DESC, n.created_at DESC
            </when>
            <otherwise>
                ORDER BY n.notice_start_at DESC,n.created_at DESC
            </otherwise>
        </choose>
        LIMIT #{size} OFFSET #{page}
    </select>

    <select id="getNoticeCount" parameterType="NoticeSearchRequest" resultType="int">
        SELECT COUNT(*)
        FROM notice n
        LEFT JOIN admin ac ON ac.id = n.created_user_id
        LEFT JOIN admin au ON au.id = n.updated_user_id
        <where>
            <if test="title != null and title != ''">
                AND n.title LIKE CONCAT('%', #{title}, '%')
            </if>
            <if test="content != null and content != ''">
                AND n.content LIKE CONCAT('%', #{content}, '%')
            </if>
            <if test="status != null and status != ''">
                AND n.status = #{status}
            </if>
            <if test="priority != null and priority != ''">
                AND n.priority = #{priority}
            </if>
            <!-- 사용자용 검색일 때만 현재 날짜가 공지 기간 내에 있는 공지사항만 조회 -->
            <if test="isUserSearch == true">
                AND (n.notice_start_at IS NULL OR n.notice_start_at &lt;= NOW())
                AND (n.notice_end_at IS NULL OR n.notice_end_at &gt;= NOW())
            </if>
        </where>
    </select>

    <!-- 공지사항 조회수 TOP5 조회 (사용자용 - 날짜 조건 적용) -->
    <select id="getTop5Notices" resultType="NoticeResponse">
        SELECT 
            n.id,
            n.title,
            n.content,
            n.status,
            n.priority,
            n.notice_start_at as noticeStartAt,
            n.notice_end_at as noticeEndAt,
            n.view_count as viewCount,
            n.created_at as createdAt,
            n.updated_at as updatedAt,
            n.created_user_id as createdUserId,
            u.name as createdUserName
        FROM notice n
        LEFT JOIN user u ON n.created_user_id = u.id
        WHERE n.status = 'ACTIVE'
          AND (n.notice_start_at IS NULL OR n.notice_start_at &lt;= NOW())
          AND (n.notice_end_at IS NULL OR n.notice_end_at &gt;= NOW())
        ORDER BY n.view_count DESC
        LIMIT 5
    </select>

</mapper>
