<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.mapper.UserMapper">

    <!-- 사용자 검색 -->
    <select id="searchUsers" parameterType="UserSearchRequest" resultType="UserResponse">
        SELECT 
            u.id,
            u.name,
            u.email,
            u.status,
            u.created_at as createdAt,
            u.last_login_at as lastLoginAt,
            url.daily_limit,
            url.monthly_limit,
            url.single_limit,
            CASE 
                WHEN url.daily_limit IS NULL THEN  'C'
                ELSE 'P' 
            END AS limit_type
        FROM user u
        LEFT JOIN user_remittance_limit url ON u.id = url.user_id
        <where>
            <if test="name != null and name != ''">
                AND u.name LIKE CONCAT('%', #{name}, '%')
            </if>
            <if test="email != null and email != ''">
                AND u.email LIKE CONCAT('%', #{email}, '%')
            </if>
            <if test="status != null and status != ''">
                AND u.status = #{status}
            </if>
            <if test="limitType != null and limitType != ''">
               <if test='limitType == "C"'>
                AND url.daily_limit IS NULL
               </if>
              <if test='limitType == "P"'>
                AND url.daily_limit IS NOT NULL
               </if>
            </if>
        </where>
        <choose>
            <when test="sortOrder == 'name'">
                ORDER BY u.name
            </when>
            <when test="sortOrder == 'dailyLimit'">
                ORDER BY url.daily_limit DESC
            </when>
            <when test="sortOrder == 'monthlyLimit'">
                ORDER BY url.monthly_limit DESC
            </when>
            <when test="sortOrder == 'singleLimit'">
                ORDER BY url.single_limit DESC
            </when>
            <otherwise>
                ORDER BY u.name
            </otherwise>
        </choose>
        LIMIT #{size} OFFSET #{page}
    </select>

    <!-- 사용자 검색 결과 개수 -->
    <select id="getUserCount" parameterType="UserSearchRequest" resultType="int">
        SELECT COUNT(*)
        FROM user u
        LEFT JOIN user_remittance_limit url ON u.id = url.user_id
        <where>
            <if test="name != null and name != ''">
                AND u.name LIKE CONCAT('%', #{name}, '%')
            </if>
            <if test="email != null and email != ''">
                AND u.email LIKE CONCAT('%', #{email}, '%')
            </if>
            <if test="status != null and status != ''">
                AND u.status = #{status}
            </if>
            <if test="limitType != null and limitType != ''">
              <if test='limitType == "C"'>
                AND url.daily_limit IS NULL
               </if>
              <if test='limitType == "P"'>
                AND url.daily_limit IS NOT NULL
               </if>
            </if>
        </where>
    </select>

    <!-- 특정 사용자 조회 -->
    <select id="getUserById" parameterType="long" resultType="UserResponse">
        SELECT 
            u.id,
            u.name,
            u.email,
            u.status,
            u.created_at as createdAt,
            u.last_login_at as lastLoginAt,
            url.daily_limit,
            url.monthly_limit,
            url.single_limit,
            CASE 
                WHEN url.daily_limit IS NULL THEN  'C'
                ELSE 'P' 
            END AS limit_type 
        FROM user u
        LEFT JOIN user_remittance_limit url ON u.id = url.user_id
        WHERE u.id = #{id}
    </select>

    <!-- 사용자 상태 업데이트 -->
    <update id="updateUserStatus">
        UPDATE user 
        SET status = #{status}
        WHERE id = #{id}
    </update>

</mapper> 